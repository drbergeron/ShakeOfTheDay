@model ShakeotDay.ViewModels.GameHand
@{
    ViewData["Title"] = "Game Details";
}


<nav>
    <a asp-area="" asp-controller="Game" asp-action="Index" >&lt; &lt; Back</a>
</nav>


<div id="gamedetailswrapper">
    <h3>Playing Games and viewing detailed results.</h3>
    <table class="game">
        <tr>
            <th>Id</th>
            <th>Game Closed?</th>
            <th>Rolls Taken</th>
            <th>Win?</th>
        </tr>
        
        <tr>
            <td>
                @Model.CurrentGame.Id
            </td>
            <td id="isClosed">@Model.CurrentGame.isClosed</td>
            <td id="rollsTaken">@Model.CurrentGame.RollsTaken</td>
            <td id="isWinning">@Model.CurrentGame.isWinningGame</td>
        </tr>
    </table>

    <div class="playpanel">
        
            <div class="playarea">
                <div class="diceInstructions" id="message"></div>
                <div class="dicearea">
                    @foreach(var die in Model.CurrentHand.Hand.Select((game,i) => new { i, game }))
                    {
                        <div class="die @(die.game.holding ? "diehold" : "")" data-held="@die.game.holding" data-handpos="@die.i"> @die.game.dieValue </div>
                    }
                </div>
                <div class="diceControlArea">
                    <button class="btn btn-primary btn-block @(Model.CurrentGame.isClosed ? "disabled" : "active") " 
                            id="roll_button" data-gameNo="@Model.CurrentGame.Id" > Roll </button>
                    user @ViewData["UserId"]
                </div>
            </div>
       

    </div>
    @section Scripts {
        <script>

            var thisHandModel = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.CurrentHand));           

            var closed = @Model.CurrentGame.isClosed.ToString().ToLower();

            $(".die").click(function () {
                if(thisHandModel.RollNumber != 0 && !closed ){//flip held value
                    logHand(thisHandModel);
                    $(this).toggleClass('diehold');
                    thisHandModel.Hand[parseInt($(this).data("handpos"))].holding = $(this).data("held") == "true" ? "false" : "true";
                    $(this).data("held", ($(this).data("held") === "true" ? "false" : "true"))
                    
                }
            });
        
            function clearDie() {
                $(this).text('');
            }

            function logHand(gamehandIn){
                console.log(gamehandIn);
            }

            var newHand = null;
            $('#roll_button').click(function(){
                
                var postdata = JSON.stringify(thisHandModel);
                console.log("postdata:" + postdata);

                var newHand = null;
                $.ajax({
                    url: "@Url.Content($"~/api/Game/{Model.CurrentGame.Id}/roll/{ViewData["UserId"]}")",
                    data : postdata,
                    contentType:"application/json; charset=utf-8",
                    success: function( dataIn ) {

                        if(dataIn.errorNumber && dataIn.errorNumber != 0){
                            alert("Error: " + dataIn.errorType + "\n" + dataIn.errorMessage);
                        }
                        else{
                            console.log(dataIn);
                            $('.dicearea div').each(function(){
                                $(this).text(dataIn.hand[parseInt($(this).data("handpos"))].dieValue);
                                $(this).data("hold",dataIn.hand[parseInt($(this).data("handpos"))].holding);
                            });

                            $('#rollsTaken').text( dataIn.rollNumber);
                            if(dataIn.rollNumber === 3){
                                $('#isClosed').text = "Closed";
                            }
                            thisHandModel = dataIn;
                            logHand(thisHandModel);
                        }
                    },  
                    type: "POST",
                    error: function(jqx, stat, err){
                        console.log("jq: " + jqx + "stat: " + stat + " err:" + err);                    
                    }                    
                });
            });

            $('#message').text( function(){
                var closed = @Model.CurrentGame.isClosed.ToString().ToLower();
                var rolls = @Model.CurrentGame.RollsTaken;

                if(closed == true){
                    return "No more rolls available.";
                }else if(rolls == 0){
                    return "Click Roll to Begin";
                }else
                    return "Click Dice to hold, then roll again."
            });

            function updateDiceUI( data ){
                
                
            }

        </script>
    }
    
</div>

